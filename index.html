<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/images/appwrite.svg" />
  <title>Appwrite + Javascript </title>
  <link rel="stylesheet" href="./style/app.css">
</head>
<body>
<main class="u-flex u-flex-vertical u-padding-20 u-cross-center u-gap-32 checker-background" id="main">
  <div class="connection-visual">
    <div class="outer-card">
      <div class="inner-card">
        <img src="./images/javascript.svg" width='72' height='72' alt='Javascript logo'/>
      </div>
    </div>
    <div class="connection-line" id="connection-line">
      <div class="line-left"></div>
      <div class="u-flex u-main-center u-border-radius-circle tick-container icon-check" style="color: #fd366e;"></div>
      <div class="line-right"></div>
    </div>
    <div class="outer-card">
      <div class="inner-card">
        <img src="./images/appwrite.svg" width='72' height='72' alt='Appwrite logo'/>
      </div>
    </div>
  </div>

  <section class="u-flex u-flex-vertical u-main-center u-cross-center u-padding-16" style="backdrop-filter: blur(1px); height: 200px;">
    <div id="status-message">
      <h1 class="heading-level-5">Check connection</h1>
    </div>
    <p class="body-text-2 u-text-center" id="status-description">
      <span>Send a ping to verify the connection</span>
    </p>
    <button class="button u-margin-block-start-32" id="ping-button">
      <span>Send a ping</span>
    </button>
  </section>

  <nav class="u-grid">
    <ul class="u-flex u-flex-wrap u-main-center u-gap-32">
      <li class="card u-max-width-300 u-flex-vertical u-gap-8" style="--p-card-padding: 1em;">
        <h2 class="heading-level-7">Edit your app</h2>
        <p class="body-text-2">Edit <code class="inline-code">index.html</code> to get started with building your app</p>
      </li>
      <li class="card u-max-width-300" style="--p-card-padding: 1em;">
        <a href="https://cloud.appwrite.io" target="_blank" rel="noopener noreferrer" class="u-flex-vertical u-gap-8">
          <div class="u-flex u-main-space-between u-cross-center">
            <h2 class="heading-level-7">Head to Appwrite Cloud</h2>
            <span class="icon-arrow-right" style="color: hsl(var(--color-neutral-15));"></span>
          </div>
          <p class="body-text-2">Start managing your project from the Appwrite console</p>
        </a>
      </li>
      <li class="card u-max-width-300" style="--p-card-padding: 1em;">
        <a href="https://appwrite.io/docs" target="_blank" rel="noopener noreferrer" class="u-flex-vertical u-gap-8">
          <div class="u-flex u-main-space-between u-cross-center">
            <h2 class="heading-level-7">Explore docs</h2>
            <span class="icon-arrow-right" style="color: hsl(var(--color-neutral-15));"></span>
          </div>
          <p class="body-text-2">Discover the full power of Appwrite by diving into our documentation</p>
        </a>
      </li>
    </ul>
  </nav>

  <aside class="collapsible u-width-full-line u-position-fixed" style="border: 1px solid hsl(var(--color-neutral-10)); bottom: 0;">
    <div class="collapsible-item">
      <details class="collapsible-wrapper u-padding-0" style="background-color: hsl(var(--color-neutral-0));" id="logs-details">
        <summary class="collapsible-button u-padding-16">
          <span class="text">Logs</span>
          <span class="collapsible-button-optional" id="log-count"></span>
          <div class="icon">
            <span class="icon-cheveron-down" aria-hidden="true"></span>
          </div>
        </summary>
        <div class="collapsible-content u-flex u-flex-vertical-mobile u-cross-stretch u-padding-0">
          <div class="table is-table-row-medium-size u-stretch" style="--p-border-radius: 0; inline-size: unset;">
            <div class="table-thead" style="background-color: hsl(var(--color-neutral-5));">
              <div class="table-row">
                <div class="table-thead-col">
                  <span class="u-color-text-offline">Project</span>
                </div>
              </div>
            </div>
            <div class="grid-box u-padding-16" style="--grid-gap: 2rem; --grid-item-size-small-screens: 10rem; --grid-item-size: 10rem; background-color: hsl(var(--color-neutral-0));">
              <div class="u-grid u-grid-vertical u-gap-8">
                <p class="u-color-text-offline">Endpoint</p>
                <p class="body-text-2" id="endpoint"></p>
              </div>
              <div class="u-grid u-grid-vertical u-gap-8">
                <p class="u-color-text-offline">Project ID</p>
                <p class="body-text-2" id="project-id"></p>
              </div>
              <div class="u-grid u-grid-vertical u-gap-8">
                <p class="u-color-text-offline">Project name</p>
                <p class="body-text-2" id="project-name"></p>
              </div>
            </div>
          </div>

          <table class="table is-table-row-small-size" style="--p-border-radius: 0; flex: 2;">
            <thead class="table-thead" style="background-color: hsl(var(--color-neutral-5));">
            <tr class="table-row u-grid" style="grid-template-columns: 3fr 2fr 2fr 2fr 5fr; min-block-size: unset;">
              <th class="table-thead-col"><span class="u-color-text-offline">Date</span></th>
              <th class="table-thead-col"><span class="u-color-text-offline">Status</span></th>
              <th class="table-thead-col"><span class="u-color-text-offline">Method</span></th>
              <th class="table-thead-col"><span class="u-color-text-offline">Path</span></th>
              <th class="table-thead-col"><span class="u-color-text-offline">Response</span></th>
            </tr>
            </thead>
            <tbody class="table-tbody u-flex u-flex-vertical u-font-code u-overflow-y-auto" style="max-height: 16em;" id="logs-table">
            </tbody>
          </table>
        </div>
      </details>
    </div>
  </aside>
</main>

<script type="module">
  import { client } from "./lib/appwrite.js";
  import { AppwriteException } from "appwrite";
  import "@appwrite.io/pink";
  import "@appwrite.io/pink-icons";

  let detailHeight = 0;
  let logs = [];
  let status = "idle";
  let showLogs = false;
  const detailsRef = document.getElementById('logs-details');

  const updateHeight = () => {
    if (detailsRef) {
      detailHeight = detailsRef.clientHeight;
      document.getElementById('main').style.marginBottom = `${detailHeight}px`;
    }
  };

  window.addEventListener("resize", updateHeight);

  detailsRef.addEventListener('toggle', updateHeight);

  async function sendPing() {
    if (status === "loading") return;
    status = "loading";
    document.getElementById('ping-button').style.visibility = "hidden";
    document.getElementById('status-message').innerHTML = '<div class="u-flex u-cross-center u-gap-16"><div class="loader is-small"></div><h1 class="heading-level-7">Waiting for connection...</h1></div>';

    try {
      const result = await client.ping();
      const log = {
        date: new Date(),
        method: "GET",
        path: "/v1/ping",
        status: 200,
        response: JSON.stringify(result),
      };
      logs = [log, ...logs];
      status = "success";
    } catch (err) {
      const log = {
        date: new Date(),
        method: "GET",
        path: "/v1/ping",
        status: err instanceof AppwriteException ? err.code : 500,
        response: err instanceof AppwriteException ? err.message : "Something went wrong",
      };
      logs = [log, ...logs];
      status = "error";
    }
    showLogs = true;
    detailsRef.open = true;
    renderLogs();
    updateHeight();
    updateStatusMessage();
    document.getElementById('ping-button').style.visibility = "visible";
  }

  function updateStatusMessage() {
    const statusMessage = document.getElementById('status-message');
    const statusDescription = document.getElementById('status-description');
    if (status === "loading") {
      statusMessage.innerHTML = '<h1 class="heading-level-7">Waiting for connection...</h1>';
    } else if (status === "success") {
      statusMessage.innerHTML = '<h1 class="heading-level-5">Congratulations!</h1>';
      statusDescription.innerHTML = '<span>You connected your app successfully.</span>';
    } else {
      statusMessage.innerHTML = '<h1 class="heading-level-5">Check connection</h1>';
      statusDescription.innerHTML = '<span>Send a ping to verify the connection</span>';
    }
  }

  function renderLogs() {
    const logsTable = document.getElementById('logs-table');
    const logCount = document.getElementById('log-count');
    logsTable.innerHTML = '';
    if (logs.length > 0) {
      logs.forEach((log, index) => {
        const row = document.createElement('tr');
        row.className = 'table-row u-grid u-height-auto';
        row.style = 'grid-template-columns: 3fr 2fr 2fr 2fr 5fr; min-block-size: unset;';
        row.innerHTML = `
                        <td class="table-col u-flex u-cross-center" data-title="Date">
                            <time class="text">${log.date.toLocaleString("en-US", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" })}</time>
                        </td>
                        <td class="table-col u-flex u-cross-center" data-title="Status">
                            <span class="tag ${log.status >= 400 ? "is-warning" : "is-success"}">${log.status}</span>
                        </td>
                        <td class="table-col u-flex u-cross-center" data-title="Method">
                            <span class="text">${log.method}</span>
                        </td>
                        <td class="table-col u-flex u-cross-center" data-title="Path">
                            <span class="text">${log.path}</span>
                        </td>
                        <td class="table-col u-flex u-cross-center" data-title="Response">
                            <code class="inline-code u-un-break-text u-overflow-x-auto">${log.response}</code>
                        </td>
                    `;
        logsTable.appendChild(row);
      });
      logCount.innerHTML = `<span class="inline-tag"><span class="text">${logs.length}</span></span>`;
    } else {
      const row = document.createElement('tr');
      row.className = 'table-row u-height-auto';
      row.style = 'min-block-size: unset;';
      row.innerHTML = '<td colSpan="5"><p class="u-color-text-offline u-padding-16">There are no logs to show</p></td>';
      logsTable.appendChild(row);
    }
  }

  document.getElementById('ping-button').addEventListener('click', sendPing);

  document.getElementById('endpoint').textContent = import.meta.env.VITE_APPWRITE_ENDPOINT;
  document.getElementById('project-id').textContent = import.meta.env.VITE_APPWRITE_PROJECT_ID;
  document.getElementById('project-name').textContent = import.meta.env.VITE_APPWRITE_PROJECT_NAME;

  updateHeight();
</script>
</body>
</html>
